<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>íšŒì›ê°€ì…</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
body {
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	background-color: #f4f6fa;
	margin: 0;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	height: 100vh;
}

.join-container {
	background-color: white;
	padding: 40px;
	border-radius: 12px;
	box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
	width: 100%;
	max-width: 400px;
}

h2 {
	text-align: center;
	margin-bottom: 30px;
	color: #337DFF;
}

label {
	display: block;
	margin-bottom: 8px;
	font-weight: bold;
	color: #333;
}

input[type="text"], input[type="password"] {
	width: 100%;
	padding: 12px;
	margin-bottom: 20px;
	border-radius: 6px;
	border: 1px solid #ccc;
	font-size: 14px;
}

.form-row {
	position: relative;
	display: flex;
	align-items: center;
}

.form-row button {
	width: 80px; /* ì ì ˆí•œ ê°’ìœ¼ë¡œ ì¡°ì ˆ */
	margin-left: 10px;
	padding: 8px 12px;
	font-size: 13px;
	border: none;
	background-color: #337DFF;
	color: white;
	border-radius: 6px;
	cursor: pointer;
}

.form-row span {
	margin-left: 10px;
	font-size: 13px;
}

.match-msg {
	font-size: 13px;
}

.match {
	color: green;
}

.mismatch {
	color: red;
}

button[type="submit"] {
	width: 100%;
	padding: 12px;
	background-color: #337DFF;
	color: white;
	border: none;
	border-radius: 6px;
	font-size: 15px;
	cursor: pointer;
	margin-top: 10px;
}

button[type="submit"]:hover {
	background-color: #1d5fd9;
}

.email-container {
	display: flex;
	align-items: center;
	gap: 5px;
}

input.email-local-part, select.email-domain {
	height: 35px;
	font-size: 16px;
}

#at-symbol { /*ì´ë©”ì¼ í˜•ì‹ ê³¨ë±…ì´ í¬ê¸° í‚¤ìš°ê¸°*/
	font-size: 24px;
	padding: 0 8px;
	font-weight: bold;
	line-height: 35px; /* input ë†’ì´ì— ë§ì¶¤ */
}
</style>
</head>
<body>

	<div class="join-container">
		<h2>íšŒì›ê°€ì…</h2>

		<form action="/join" method="post" id="joinForm">

			<label for="username" >ì•„ì´ë””</label>
			<div class="form-row">
				<input type="text" id="username" name="username" required
					th:value="${user != null} ? ${user.username} : ''" placeholder="ì˜ë¬¸,ìˆ«ìë¥¼ ì¡°í•©í•´ì„œ ID ì‘ì„±">
				<button type="button" onclick="checkUsername()">
					ì¤‘ë³µ<br>í™•ì¸
				</button>
			</div>
			<span id="checkResult"></span> <label for="password">ë¹„ë°€ë²ˆí˜¸</label> <input
				type="password" id="password" name="password" required> <label
				for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label> <input type="password"
				id="confirmPassword" required onkeyup="checkPasswordMatch()">
			<span id="passwordMatchMsg" class="match-msg"></span> <label
				for="name">ì´ë¦„</label> <input type="text" id="name" name="name"
				required th:value="${user != null} ? ${user.name} : ''"> <label
				for="emailId">ì´ë©”ì¼</label> <input type="hidden" id="fullEmail"
				name="email" />

			<div class="form-row">
				<div class="email-container">
					<input type="text" id="emailId" name="emailId" required
						th:value="${user != null} ? ${#strings.substringBefore(user.email, '@')} : ''"
						placeholder="ì´ë©”ì¼ ì•„ì´ë””" style="font-size: 16px;" /> <span
						id="at-symbol" style="font-size: 22px; padding: 0 3px;">@</span> <select
						id="emailDomain" name="emailDomain" required
						style="width: 150px; height: 35px; font-size: 16px;">
						<option
							th:selected="${user != null and #strings.substringAfter(user.email, '@') == 'gmail.com'}"
							value="gmail.com">gmail.com</option>
						<option
							th:selected="${user != null and #strings.substringAfter(user.email, '@') == 'naver.com'}"
							value="naver.com">naver.com</option>
						<option
							th:selected="${user != null and #strings.substringAfter(user.email, '@') == 'daum.net'}"
							value="daum.net">daum.net</option>
						<option
							th:selected="${user != null and !(#strings.substringAfter(user.email, '@') == 'gmail.com' or #strings.substringAfter(user.email, '@') == 'naver.com' or #strings.substringAfter(user.email, '@') == 'daum.net')}"
							value="custom">ì§ì ‘ ì…ë ¥</option>

						<!-- ì´ë©”ì¼ ê´€ë ¨ input ì•„ë˜ì— ì¶”ê°€ -->



					</select>

					<!-- ì§ì ‘ ì…ë ¥í•  ë„ë©”ì¸ í…ìŠ¤íŠ¸ ë°•ìŠ¤, ê¸°ë³¸ì€ ìˆ¨ê¹€ -->
					<input type="text" id="customDomain" name="customDomain"
						placeholder="ë„ë©”ì¸ ì…ë ¥"
						style="height: 35px; font-size: 16px; width: 150px; display: none;" />
				</div>



				<button type="button" onclick="sendVerificationEmail()">
					ì¸ì¦<br>í•˜ê¸°
				</button>


			</div>

			<span id="emailVerifyResult"></span>
			<!-- ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ ì—¬ë¶€ ì¶”ì ìš© hidden -->
			<input type="hidden" id="emailVerified" name="emailVerified"
				value="false" />

			<!-- ì—ëŸ¬ ë©”ì‹œì§€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ -->
			<div style="color: red; margin-top: 10px;">
				<span th:text="${error}"></span>
			</div>

			<script>
  const domainSelect = document.getElementById('emailDomain');
  const customDomainInput = document.getElementById('customDomain');

  function toggleCustomDomain() {
    if (domainSelect.value === 'custom') {
      customDomainInput.style.display = 'inline-block';
      customDomainInput.required = true;
    } else {
      customDomainInput.style.display = 'none';
      customDomainInput.required = false;
      customDomainInput.value = '';
    }
  }

  domainSelect.addEventListener('change', toggleCustomDomain);

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
  window.addEventListener('load', () => {
    toggleCustomDomain();
  });
</script>

			<input type="hidden" id="emailVerified" name="emailVerified" value="false" />
			
			<button type="submit">ê°€ì…í•˜ê¸°</button>
		</form>

		<script>
			function checkPasswordMatch() {
				const pw = document.getElementById('password').value;
				const cpw = document.getElementById('confirmPassword').value;
				const msg = document.getElementById('passwordMatchMsg');

				if (!cpw) {
					msg.textContent = '';
					return;
				}

				if (pw === cpw) {
					msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
					msg.style.color = 'green';
				} else {
					msg.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
					msg.style.color = 'red';
				}
			}
		</script>

	</div>

	<script>
  // ì¤‘ë³µì²´í¬ í†µê³¼ ì—¬ë¶€ í”Œë˜ê·¸ ì¶”ê°€
  let usernameChecked = false;

  function sendVerificationEmail() {
    const id = $("#emailId").val().trim();
    let domain = $("#emailDomain").val();
    const custom = $("#customDomain").val().trim();

    $("#emailVerifyResult").text("");
    $("span[th\\:text='${error}']").text("");

    if (domain === 'custom') {
      if (!custom) {
        showEmailError("ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      domain = custom;
    }

    const fullEmail = id + "@" + domain;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!emailRegex.test(fullEmail)) {
      showEmailError("ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    $("#fullEmail").val(fullEmail);

    $.ajax({
    	  url: "/email/send-verification-email",   // ì‹¤ì œ ë°±ì—”ë“œ API ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”
    	  method: "POST",                    // ì„œë²„ê°€ POST ë°©ì‹ì´ë¼ë©´ POST
    	  contentType: "application/json",
    	  data: JSON.stringify({ email: fullEmail }),
    	  success: function () {
    	    showEmailSuccess("ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.");
    	    $("#emailVerified").val("true");
    	  },
    	  error: function (xhr, status, error) {
    	    console.error("ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:", status, error, xhr.responseText);
    	    showEmailError("ì¸ì¦ ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    	  }
    	});
  }

  // ì´ë©”ì¼ ì…ë ¥ê°’ ë³€ê²½ì‹œ ì¸ì¦ ì´ˆê¸°í™”
  $("#emailId, #emailDomain, #customDomain").on("input change", function () {
    $("#emailVerified").val("false");
    $("#emailVerifyResult").text("");
    console.log("ì´ë©”ì¼ ë³€ê²½ë¨, ì¸ì¦ ì´ˆê¸°í™”");
  });

  // ì´ë©”ì¼ ë©”ì‹œì§€ ì¶œë ¥ ë„ìš°ë¯¸ í•¨ìˆ˜
  function showEmailSuccess(message) {
    $("#emailVerifyResult").text(message).css("color", "green");
  }

  function showEmailError(message) {
    $("#emailVerifyResult").text(message).css("color", "red");
  }

  // ì•„ì´ë”” ì¤‘ë³µì²´í¬ í•¨ìˆ˜
  function checkUsername() {
    const username = $("#username").val();

    if (!username) {
      $("#checkResult").text("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.").css("color", "red");
      usernameChecked = false;  // ì¤‘ë³µì²´í¬ ì‹¤íŒ¨ ìƒíƒœ
      return;
    }

    $.ajax({
      url: "/check-username",
      method: "GET",
      data: { username: username },
      success: function (response) {
        if (response === true) {
          $("#checkResult").text("ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.").css("color", "green");
          usernameChecked = true;  // ì¤‘ë³µ ì•„ë‹˜, ì²´í¬ ì™„ë£Œ
        } else {
          $("#checkResult").text("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.").css("color", "red");
          usernameChecked = false;
        }
      },
      error: function () {
        $("#checkResult").text("ì˜¤ë¥˜ ë°œìƒ").css("color", "red");
        usernameChecked = false;
      }
    });
  }

  // ì•„ì´ë”” ì…ë ¥ ë³€ê²½ ì‹œ ì¤‘ë³µì²´í¬ í”Œë˜ê·¸ ì´ˆê¸°í™”
  $("#username").on("input", function () {
    usernameChecked = false;
    $("#checkResult").text("");
  });

  $(document).ready(function () {
    $('#password, #confirmPassword').on('keyup', function () {
      const pw = $('#password').val();
      const confirmPw = $('#confirmPassword').val();

      if (!confirmPw) {
        $('#passwordMatchMsg').text('').removeClass('match mismatch');
        return;
      }

      if (pw === confirmPw) {
        $('#passwordMatchMsg').text('ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜').removeClass('mismatch').addClass('match');
      } else {
        $('#passwordMatchMsg').text('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜').removeClass('match').addClass('mismatch');
      }
    });

    // ê°€ì… í¼ ì œì¶œ ì‹œ ì¤‘ë³µì²´í¬ & ì´ë©”ì¼ ì¸ì¦ ê²€ì‚¬, ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì‚¬
    $("#joinForm").on("submit", function (e) {
    	  // 1. ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
    	  if (!usernameChecked) {
    	    e.preventDefault();
    	    $("#checkResult").text("ì•„ì´ë”” ì¤‘ë³µì²´í¬ë¥¼ í•´ì£¼ì„¸ìš”.").css("color", "red");
    	    $("#username").focus();
    	    return;
    	  }

    	  // 2. ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€ ê²€ì‚¬
    	  const isVerified = $("#emailVerified").val();
    	  if (isVerified !== "true") {
    	    e.preventDefault();
    	    showEmailError("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
    	    return;
    	  }

    	  // 3. ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
    	  const pw = $("#password").val();
    	  const cpw = $("#confirmPassword").val();
    	  if (pw !== cpw) {
    	    e.preventDefault();
    	    $("#passwordMatchMsg").text("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.").css("color", "red");
    	    return;
    	  }
    	});
  		});

  function validateEmail() {
    const id = document.getElementById('emailId').value.trim();
    let domain = document.getElementById('emailDomain').value;

    if (domain === 'custom') {
      domain = prompt("ë„ë©”ì¸ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”:");
      if (!domain) {
        alert("ë„ë©”ì¸ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
        return false;
      }
    }

    const email = id + '@' + domain;
    document.getElementById('fullEmail').value = email;

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
      alert("ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      return false;
    }

    return true;
  }
  
  
 
</script>



	<script>
    document.getElementById("joinForm").addEventListener("submit", function (e) {
        const emailId = document.getElementById("emailId").value.trim();
        const emailDomain = document.getElementById("emailDomain").value;
        const customDomain = document.getElementById("customDomain").value.trim();

        let domain = emailDomain === "custom" ? customDomain : emailDomain;
        let fullEmail = emailId + "@" + domain;

        // ğŸ’¡ hidden í•„ë“œì— ì„¤ì • (form ì „ì†¡ ì§ì „)
        document.getElementById("fullEmail").value = fullEmail;

        // (ì„ íƒ) ì¸ì¦ ì—¬ë¶€ ì²´í¬
        const isVerified = document.getElementById("emailVerified").value;
        if (isVerified !== "true") {
            e.preventDefault(); // ì „ì†¡ ì¤‘ì§€
            alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
        }
    });
</script>


</body>
</html>
